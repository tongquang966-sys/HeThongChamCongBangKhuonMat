@{
    ViewData["Title"] = "Ch·∫•m c√¥ng";
    Layout = "_Layout";
}

<h3 class="mb-3">üì∑ Ch·∫•m c√¥ng b·∫±ng khu√¥n m·∫∑t</h3>

<div class="row">
    <!-- CAMERA -->
    <div class="col-md-6">
        <video id="video" width="100%" autoplay muted class="border rounded"></video>
        <canvas id="canvas" class="d-none"></canvas>

        <button class="btn btn-primary mt-3" onclick="chamCong()">
            üì∏ Ch·∫•m c√¥ng
        </button>
    </div>

    <!-- K·∫æT QU·∫¢ -->
    <div class="col-md-6">
        <div id="result" class="alert alert-info">
            Ch∆∞a ch·∫•m c√¥ng
        </div>
    </div>
</div>

<script>
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const result = document.getElementById("result");

    // =========================
    // M·ªû CAMERA
    // =========================
    navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => video.srcObject = stream)
        .catch(err => alert("Kh√¥ng m·ªü ƒë∆∞·ª£c camera"));

    // =========================
    // CH·∫§M C√îNG
    // =========================
    async function chamCong() {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0);

        const base64 = canvas.toDataURL("image/jpeg").split(",")[1];

        result.innerHTML = "‚è≥ ƒêang nh·∫≠n di·ªán...";

        const res = await fetch("/ChamCong/ChamCong", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ imageBase64: base64 })
        });

        const data = await res.json();

        if (data.success) {
            result.className = "alert alert-success";
            result.innerHTML = "‚úÖ Ch·∫•m c√¥ng th√†nh c√¥ng: <b>" + data.hoTen + "</b>";
        } else {
            result.className = "alert alert-danger";
            result.innerHTML = "‚ùå " + data.message;
        }
    }
</script>
